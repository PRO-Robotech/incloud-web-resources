# Factory definition for Deployment details page
apiVersion: front.in-cloud.io/v1alpha1
kind: Factory
metadata:
  name: deployment-details
spec:
  # Stable key used by the UI router/registry
  key: deployment-details

  # Sidebar categorization
  sidebarTags:
    - deployment-sidebar

  # API request used to fetch the target Deployment
  urlsToFetch:
    - /api/clusters/{2}/k8s/apis/apps/v1/namespaces/{3}/deployments/{6}

  # Enables scrollable main content area
  withScrollableMainContentCard: true

  # Root component tree
  data:
    # === Header with icon, name and high-level status ===
    - type: antdFlex
      data:
        id: header-flex
        gap: 6
        align: center
        style:
          marginBottom: 24px
      children:
        # Left: static "D" label for Deployment
        - type: antdText
          data:
            id: header-icon
            text: D
            title: Deployment
            style:
              backgroundColor: "#004080"
              borderRadius: 20px
              color: "#fff"
              display: inline-block
              fontFamily: RedHatDisplay, Overpass, helvetica, sans-serif
              fontSize: 20px
              fontWeight: 400
              lineHeight: 24px
              minWidth: 24
              padding: 0 9px
              textAlign: center
              whiteSpace: nowrap

        # Center: deployment name from the fetched object
        - type: parsedText
          data:
            id: header-name
            text: "{reqsJsonPath[0]['.metadata.name']['-']}"
            style:
              fontSize: 20px
              lineHeight: 24px
              fontFamily: RedHatDisplay, Overpass, overpass, helvetica, arial, sans-serif

        # Right: status (Available or error) based on condition reason
        - type: StatusText
          data:
            id: header-status
            value: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"
            criteriaSuccess: equals
            valueToCompareSuccess:
              - "MinimumReplicasAvailable"
            criteriaError: equals
            valueToCompareError:
              - "DeploymentReplicaFailure"
              - "ProgressDeadlineExceeded"
            successText: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"
            errorText: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"
            fallbackText: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"

    # === Main content organized by tabs ===
    - type: antdTabs
      data:
        id: deployment-tabs
        defaultActiveKey: details
        items:
          # ------ DETAILS TAB ------
          - key: details
            label: Details
            children:
              # Card wrapper for details content
              - type: ContentCard
                data:
                  id: details-card
                  style:
                    marginBottom: 24px
                children:
                  # Section title
                  - type: antdText
                    data:
                      id: details-title
                      text: Deployment details
                      strong: true
                      style:
                        fontSize: 20
                        marginBottom: 12px

                  # Spacer for breathing room
                  - type: Spacer
                    data:
                      id: details-spacer
                      "$space": 16

                  # Two-column layout for metadata and rollout settings
                  - type: antdRow
                    data:
                      id: main-details-row
                      gutter: [48, 12]
                    children:
                      # === LEFT COLUMN: Metadata & links ===
                      - type: antdCol
                        data:
                          id: left-column
                          span: 12
                        children:
                          - type: antdFlex
                            data:
                              id: left-column-flex
                              vertical: true
                              gap: 24
                            children:
                              # Name block
                              - type: antdFlex
                                data:
                                  id: name-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: name-label
                                      text: Name
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: name-value
                                      text: "{reqsJsonPath[0]['.metadata.name']['-']}"

                              # Namespace link block (rendered by include)
                              - type: antdFlex
                                data:
                                  id: namespace-block
                                  vertical: true
                                  gap: 8
                                children:
                                  {{ include "incloud-web-resources.factory.links.details" (dict
                                      "reqIndex" 0
                                      "type" "namespace"
                                      "title" "Namespace"
                                      "jsonPath" ".metadata.namespace"
                                      "factory" "namespace-details"
                                    ) | nindent 34 
                                  }}

                              # Labels list (rendered by include)
                              - type: antdFlex
                                data:
                                  id: labels-block
                                  vertical: true
                                  gap: 8
                                children:
                                 {{ include "incloud-web-resources.factory.labels" (dict
                                      "endpoint" "/api/clusters/{2}/k8s/apis/apps/v1/namespaces/{3}/deployments/{6}"
                                    ) | nindent 34
                                  }}

                              # Node selector key-value list (rendered by include)
                              - type: antdFlex
                                data:
                                  id: node-selector-block
                                  vertical: true
                                  gap: 4
                                children:
                                  {{ include "incloud-web-resources.factory.labels.base.selector" (dict
                                      "type" "node"
                                      "title" "Node selector"
                                      "jsonPath" ".spec.template.spec.nodeSelector"
                                    ) | nindent 34
                                  }}


                              # Pod selector key-value list (rendered by include)
                              - type: antdFlex
                                data:
                                  id: pod-selector-block
                                  vertical: true
                                  gap: 4
                                children:
                                  {{ include "incloud-web-resources.factory.labels.base.selector" (dict
                                      "type" "pod"
                                      "title" "Pod selector"
                                      "jsonPath" ".spec.template.metadata.labels"
                                    ) | nindent 34
                                  }}

                              # Tolerations counter (rendered by include)
                              - type: antdFlex
                                data:
                                  id: tolerations-block
                                  vertical: true
                                  gap: 4
                                children:
                                  {{ include "incloud-web-resources.factory.counters.fields" (dict
                                      "jsonPath" ".spec.template.spec.tolerations"
                                      "type" "tolerations"
                                      "title" "Tolerations"
                                    ) | nindent 34
                                  }}
                                  - type: Tolerations
                                    data:
                                      id: tolerations
                                      reqIndex: 0
                                      jsonPathToArray: '.spec.template.spec.tolerations'
                                      text: "~counter~ Tollerations"
                                      errorText: "0 Tollerations"
                                      notificationSuccessMessage: "Updated successfully"
                                      notificationSuccessMessageDescription: "Tollerations have been updated"
                                      modalTitle: "Edit tolerations"
                                      modalDescriptionText: ""
                                      inputLabel: ""
                                      endpoint: /api/clusters/{2}/k8s/apis/apps/v1/namespaces/{3}/deployments/{6}
                                      pathToValue: "/spec/template/spec/tolerations"
                                      editModalWidth: "1000px"
                                      cols:
                                        - 8
                                        - 3
                                        - 8
                                        - 3
                                        - 2
                              # Annotations counter block
                              - type: antdFlex
                                data:
                                  id: ds-annotations
                                  vertical: true
                                  gap: 4
                                children:
                                  {{ include "incloud-web-resources.factory.counters.object.fields" (dict
                                      "jsonPath" ".metadata.annotations"
                                      "type" "annotations"
                                      "title" "Annotations"
                                    ) | nindent 34
                                  }}

                              # Created timestamp (rendered by include)
                              - type: antdFlex
                                data:
                                  id: created-time-block
                                  vertical: true
                                  gap: 4
                                children:
                                  {{ include "incloud-web-resources.factory.time.create" (dict
                                    "req" ".metadata.creationTimestamp"
                                    "text" "Created"
                                  ) | nindent 38 
                                  }}

                              # Owner reference (fallback text if no owner)
                              - type: antdFlex
                                data:
                                  id: owner-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: owner-label
                                      text: Owner
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: owner-value
                                      strong: true
                                      text: "No owner"
                                      style:
                                        color: red

                      # === RIGHT COLUMN: Rollout and timing settings ===
                      - type: antdCol
                        data:
                          id: right-column
                          span: 12
                        children:
                          - type: antdFlex
                            data:
                              id: right-column-flex
                              vertical: true
                              gap: 24
                            children:
                              # Status block (mirrors header status)
                              - type: antdFlex
                                data:
                                  id: status-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: status-label
                                      text: Status
                                      strong: true
                                  - type: StatusText
                                    data:
                                      id: status-value
                                      value: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"
                                      criteriaSuccess: equals
                                      valueToCompareSuccess:
                                        - "MinimumReplicasAvailable"
                                      criteriaError: equals
                                      valueToCompareError:
                                        - "DeploymentReplicaFailure"
                                        - "ProgressDeadlineExceeded"
                                      successText: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"
                                      errorText: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"
                                      fallbackText: "{reqsJsonPath[0]['.status.conditions[?(@.type=='Available')].reason']['-']}"

                              # Rolling update strategy type
                              - type: antdFlex
                                data:
                                  id: update-strategy-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: update-strategy-label
                                      text: Update strategy
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: update-strategy-value
                                      text: "{reqsJsonPath[0]['.spec.strategy.type']['-']}"

                              # MaxUnavailable value
                              - type: antdFlex
                                data:
                                  id: max-unavailable-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: max-unavailable-label
                                      text: Max unavailable
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: max-unavailable-value
                                      text: "{reqsJsonPath[0]['.spec.strategy.rollingUpdate.maxUnavailable']['-']}"

                              # MaxSurge value
                              - type: antdFlex
                                data:
                                  id: max-surge-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: max-surge-label
                                      text: Max surge
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: max-surge-value
                                      text: "{reqsJsonPath[0]['.spec.strategy.rollingUpdate.maxSurge']['-']}"

                              # ProgressDeadlineSeconds
                              - type: antdFlex
                                data:
                                  id: progress-deadline-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: progress-deadline-label
                                      text: Progress deadline seconds
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: progress-deadline-value
                                      text: "{reqsJsonPath[0]['.spec.progressDeadlineSeconds']['-']}"

                              # MinReadySeconds
                              - type: antdFlex
                                data:
                                  id: min-ready-seconds-block
                                  vertical: true
                                  gap: 4
                                children:
                                  - type: antdText
                                    data:
                                      id: min-ready-seconds-label
                                      text: Min ready seconds
                                      strong: true
                                  - type: parsedText
                                    data:
                                      id: min-ready-seconds-value
                                      text: "{reqsJsonPath[0]['.spec.minReadySeconds']['-']}"

                  # === Volumes table (visible only if volumes exist) ===
                  - type: antdCol
                    data:
                      id: volumes-column
                      style:
                        marginTop: 16
                        padding: 10
                    children:
                      - type: VisibilityContainer
                        data:
                          id: volumes-container
                          value: "{reqsJsonPath[0]['.spec.template.spec.volumes']['-']}"
                          style:
                            margin: 0
                            padding: 0
                        children:
                          - type: antdText
                            data:
                              id: volumes-title
                              text: Volumes
                              strong: true
                              style:
                                fontSize: 22px
                                marginBottom: 16px
                          - type: EnrichedTable
                            data:
                              id: volumes-table
                              fetchUrl: /api/clusters/{2}/k8s/apis/apps/v1/namespaces/{3}/deployments/{6}
                              clusterNamePartOfUrl: "{2}"
                              customizationId: factory-deployment-details-volume-list
                              baseprefix: /openapi-ui
                              withoutControls: true
                              # Path in the fetched object to the volumes array
                              pathToItems:
                                - spec
                                - template
                                - spec
                                - volumes

                  # ---- INIT CONTAINERS SECTION ----
                  - type: antdCol
                    data:
                      id: ds-init-containers-col
                      style:
                        marginTop: 10
                        padding: 10
                    children:
                      - type: VisibilityContainer
                        data:
                          id: ds-init-containers-container
                          value: "{reqsJsonPath[0]['.spec.template.spec.initContainers']['-']}"
                          style:
                            margin: 0
                            padding: 0
                        children:
                          {{ include "incloud-web-resources.factory.containers.table" (dict
                              "title" "Init containers"
                              "customizationId" "container-spec-init-containers-list"
                              "type" "init-containers"
                              "apiGroup" "apis/apps/v1"
                              "kind" "deployments"
                              "resourceName" "{6}"
                              "namespace" "{3}"
                              "jsonPath" ".spec.template.spec.initContainers"
                              "pathToItems" "['spec','template','spec','initContainers']"
                            ) | nindent 26
                          }}

                  # ---- CONTAINERS SECTION ----
                  - type: antdCol
                    data:
                      id: ds-containers-col
                      style:
                        marginTop: 10
                        padding: 10
                    children:
                      - type: VisibilityContainer
                        data:
                          id: ds-containers-container
                          value: "{reqsJsonPath[0]['.spec.template.spec.containers']['-']}"
                          style:
                            margin: 0
                            padding: 0
                        children:
                          {{ include "incloud-web-resources.factory.containers.table" (dict
                              "title" "Containers"
                              "customizationId" "container-spec-containers-list"
                              "type" "containers"
                              "apiGroup" "apis/apps/v1"
                              "kind" "deployments"
                              "resourceName" "{6}"
                              "namespace" "{3}"
                              "jsonPath" ".spec.template.spec.containers"
                              "pathToItems" "['spec','template','spec','containers']"
                            ) | nindent 26
                          }}

                  # === Conditions table (visible only if status.conditions exist) ===
                  - type: antdCol
                    data:
                      id: conditions-column
                      style:
                        marginTop: 16
                        padding: 10
                    children:
                      - type: VisibilityContainer
                        data:
                          id: conditions-container
                          value: "{reqsJsonPath[0]['.status.conditions']['-']}"
                          style:
                            margin: 0
                            padding: 0
                        children:
                          - type: antdText
                            data:
                              id: conditions-title
                              text: Conditions
                              strong: true
                              style:
                                fontSize: 22px
                                marginBottom: 16px
                          - type: EnrichedTable
                            data:
                              id: conditions-table
                              fetchUrl: /api/clusters/{2}/k8s/apis/apps/v1/namespaces/{3}/deployments/{6}
                              clusterNamePartOfUrl: "{2}"
                              customizationId: factory-status-conditions
                              baseprefix: /openapi-ui
                              withoutControls: true
                              # Path in the fetched object to the conditions array
                              pathToItems:
                                - status
                                - conditions

          # ------ YAML TAB ------
          - key: yaml
            label: YAML
            children:
              # In-place editor bound to the same Deployment
              - type: YamlEditorSingleton
                data:
                  id: yaml-editor
                  apiGroup: apps
                  apiVersion: v1
                  cluster: "{2}"
                  isNameSpaced: true
                  prefillValuesRequestIndex: 0
                  substractHeight: 400
                  type: apis
                  typeName: deployments

          # ------ REPLICASETS TAB ------
          - key: replicasets
            label: ReplicaSets
            children:
              # Table filtered by Deployment's Pod template labels
              - type: EnrichedTable
                data:
                  id: replicasets-table
                  fetchUrl: /api/clusters/{2}/k8s/apis/apps/v1/namespaces/{3}/replicasets
                  baseprefix: /openapi-ui
                  clusterNamePartOfUrl: "{2}"
                  customizationId: factory-/apps/v1/replicasets
                  labelsSelectorFull:
                    reqIndex: 0
                    pathToLabels:
                      - spec
                      - template
                      - metadata
                      - labels
                  # Path to items list in the response
                  pathToItems:
                    - items
                  withoutControls: true

          # ------ PODS TAB ------
          - key: pods
            label: Pods
            children:
              # Table filtered by Deployment's Pod template labels
              - type: EnrichedTable
                data:
                  id: pods-table
                  fetchUrl: /api/clusters/{2}/k8s/api/v1/namespaces/{3}/pods
                  baseprefix: /openapi-ui
                  clusterNamePartOfUrl: "{2}"
                  customizationId: factory-/v1/pods
                  labelsSelectorFull:
                    reqIndex: 0
                    pathToLabels:
                      - spec
                      - template
                      - metadata
                      - labels
                  # Path to items list in the response
                  pathToItems:
                    - items
                  withoutControls: true
